import{W as v}from"./workerManager-4c1ace2f.js";import{e as a,R as f,l as h,f as b}from"./index-fc391d71.js";function C(o,e,i){let s=null;return(...r)=>{s&&clearTimeout(s),i&&!s&&(o==null||o(...r)),s=setTimeout(()=>{clearTimeout(s),s=null,o==null||o(...r)},e)}}class I{constructor(e,i,s){this._languageId=e,this._worker=i,this._disposables=[],this._listener=Object.create(null);const r=t=>{let n=t.getLanguageId();n===this._languageId&&(this._listener[t.uri.toString()]=t.onDidChangeContent(C(()=>{this._doValidate(t.uri,n)},600)),this._doValidate(t.uri,n))},l=t=>{a.setModelMarkers(t,this._languageId,[]);let n=t.uri.toString(),u=this._listener[n];u&&(u.dispose(),delete this._listener[n])};this._disposables.push(a.onDidCreateModel(r)),this._disposables.push(a.onWillDisposeModel(l)),this._disposables.push(a.onDidChangeModelLanguage(t=>{l(t.model),r(t.model)})),s.onDidChange(t=>{a.getModels().forEach(n=>{n.getLanguageId()===this._languageId&&(l(n),r(n))})}),this._disposables.push({dispose:()=>{for(let t in this._listener)this._listener[t].dispose()}}),a.getModels().forEach(r)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(e,i){this._worker(e).then(s=>{var r;return s.doValidation(((r=a.getModel(e))===null||r===void 0?void 0:r.getValue())||"")}).then(s=>{const r=s.map(t=>w(e,t));let l=a.getModel(e);l&&l.getLanguageId()===i&&a.setModelMarkers(l,i,r)}).then(void 0,s=>{console.error(s)})}}function k(o){switch(o){default:return b.Error}}function w(o,e){return{severity:k(),startLineNumber:e.startLine,startColumn:e.startColumn,endLineNumber:e.endLine,endColumn:e.endColumn,message:e.message,code:void 0,source:"dt-sql-parser"}}class M{constructor(e,i){this._worker=e,this._defaults=i}get triggerCharacters(){return["."," "]}provideCompletionItems(e,i,s,r){const l=e.uri;return this._worker(l).then(t=>{var n;return t.doComplete(((n=a.getModel(l))===null||n===void 0?void 0:n.getValue())||"",i)}).then(t=>(typeof this._defaults.completionService=="function"?this._defaults.completionService:S)(e,i,s,t)).then(t=>{const n=e.getWordUntilPosition(i),u=new f(i.lineNumber,n.startColumn,i.lineNumber,n.endColumn);return{suggestions:t.map(d=>{var c,p,g;return Object.assign(Object.assign({},d),{insertText:(c=d.insertText)!==null&&c!==void 0?c:typeof d.label=="string"?d.label:d.label.label,range:(p=d.range)!==null&&p!==void 0?p:u,insertTextRules:(g=d.insertTextRules)!==null&&g!==void 0?g:h.CompletionItemInsertTextRule.InsertAsSnippet})})}})}}const S=function(o,e,i,s){if(!s)return Promise.resolve([]);const{keywords:r}=s,l=r.map(t=>({label:t,kind:h.CompletionItemKind.Keyword,detail:"keyword"}));return Promise.resolve(l)};function T(o){const e=[],i=[],s=new v(o);e.push(s);const r=(...t)=>s.getLanguageServiceWorker(...t);function l(){const{languageId:t,modeConfiguration:n}=o;_(i),n.diagnostics&&i.push(new I(t,r,o)),n.completionItems&&i.push(h.registerCompletionItemProvider(t,new M(r,o)))}return l(),e.push(m(i)),m(e)}function m(o){return{dispose:()=>_(o)}}function _(o){for(var e;o.length;)(e=o.pop())===null||e===void 0||e.dispose()}export{T as setupLanguageMode};
